#include <stdio.h>
#include <stdlib.h>
#include "array.h"
#include "median.h"
#include "lsd.h"
#include "img_proc.h"

static int test_draw_lines();
static int test_draw_line_indices();
static int test_lsd();
static int test_median();
static int test_pairs();

static double rd()
{
    return (double)rand() / RAND_MAX;
}

int main(int argc, char *argv[])
{
    return test_draw_line_indices();
}

static int test_draw_lines()
{
    size_t X = 32;
    size_t Y = 48;
    size_t n_lines = 1;
    double *lines = (double *)calloc(n_lines * 7, sizeof(double));
    unsigned int *out = (unsigned int *)calloc(X * Y, sizeof(unsigned int));

    if (!lines || !out)
    {
        printf("not enough memory\n");
        return EXIT_FAILURE;
    }

    lines[0] = 10.; lines[1] = 10.; lines[2] = 20.; lines[3] = 20.; lines[4] = 3.5;

    draw_lines(out, X, Y, 1, lines, n_lines, 0);

    printf("Result:\n");
    printf("%3d ", 666);
    for (int j = 0; j < (int)X; j++) printf("%3d ", j);
    printf("\n");
    for (int i = 0; i < (int)Y; i++)
    {
        printf("%3d ", i);
        for (int j = 0; j < (int)X; j++) printf("%03d ", out[j + X * i]);
        printf("\n");
    }
    printf("\n");

    free(lines); free(out);

    return EXIT_SUCCESS;
}

static int test_draw_line_indices()
{
    size_t X = 32;
    size_t Y = 48;
    size_t n_lines = 2;
    double *lines = (double *)calloc(n_lines * 7, sizeof(double));
    unsigned int *out;
    size_t n_idxs;

    if (!lines)
    {
        printf("not enough memory\n");
        return EXIT_FAILURE;
    }

    lines[0] = 10.; lines[1] = 10.; lines[2] = 20.; lines[3] = 20.; lines[4] = 3.5;
    lines[7] = 30.; lines[8] = 15.; lines[9] = 5.; lines[10] = 10.; lines[11] = 3.5;

    draw_line_indices(&out, &n_idxs, X, Y, 255, lines, n_lines, 0);

    printf("Result:\n");
    printf("idx  x   y   I \n");
    for (int i = 0; i < (int)n_idxs; i++)
    {
        for (int j = 0; j < 4; j++) printf("%03d ", out[j + 4 * i]);
        printf("\n");
    }
    printf("\n");

    free(lines); free(out);

    return EXIT_SUCCESS;
}

static int test_lsd()
{
    double *image;
    double *out;
    int x, y, i, j, n;
    int X = 128;  /* x image size */
    int Y = 128;  /* y image size */

    /* create a simple image: left half black, right half gray */
    image = (double *)malloc(X * Y * sizeof(double));
    if (image == NULL)
    {
        fprintf(stderr,"error: not enough memory\n");
        exit(EXIT_FAILURE);
    }
    for(x = 0; x < X; x++)
    {
        for(y = 0; y < Y; y++)
        {
            image[x + y * X] = x < X / 2 ? 0.0 : 64.; /* image(x,y) */
        }
    }

    /* LSD call */
    lsd(&out, &n, image, X, Y);

    /* print output */
    printf("%d line segments found:\n",n);
    for(i = 0; i < n; i++)
    {
        for(j = 0; j < 7; j++) printf("%f ", out[7 * i + j]);
        printf("\n");
    }

    /* free memory */
    free(image);
    free(out);

    return EXIT_SUCCESS;
}

static int test_median()
{
    size_t X = 30;
    size_t Y = 30;
    size_t dims[2] = {Y, X};
    size_t size = 6; 
    size_t fsize[2] = {size, size};

    double *data = (double *)malloc(X * Y * sizeof(double));
    unsigned char *mask = (unsigned char *)malloc(X * Y * sizeof(unsigned char));
    double *out = (double *)malloc(X * Y * sizeof(double));
    unsigned char *fmask = (unsigned char *)calloc(size * size, sizeof(unsigned char));

    if (!data || !mask || !out || !fmask)
    {
        printf("not enough memory\n");
        return EXIT_FAILURE;
    }

    for (int i = 0; i < (int)Y; i++)
    {
        for (int j = 0; j < (int)X; j++)
        {
            data[j + X * i] = 2 * (SQ(i - ((double)Y - 1) / 2) + SQ(j - ((double)X - 1) / 2)) / X / Y;
            mask[j + X * i] = 1;
        }
    }

    for (int i = 2; i < 4; i++)
    {
        for (int j = 0; j < (int)size; j++) fmask[j + size * i] = 1;
    }

    printf("Input:\n");
    printf("%4d ", 666);
    for (int j = 0; j < (int)X; j++) printf("%4d ", j);
    printf("\n");
    for (int i = 0; i < (int)Y; i++)
    {
        printf("%4d ", i);
        for (int j = 0; j < (int)X; j++) printf("%0.2f ", data[j + X * i]);
        printf("\n");
    }
    printf("\n");


    double cval = 0.0;
    median_filter(out, data, mask, 2, dims, sizeof(double), fsize,
    fmask, EXTEND_REFLECT, &cval, compare_uint, 1);

    printf("Result:\n");
    printf("%4d ", 666);
    for (int j = 0; j < (int)X; j++) printf("%4d ", j);
    printf("\n");
    for (int i = 0; i < (int)Y; i++)
    {
        printf("%4d ", i);
        for (int j = 0; j < (int)X; j++) printf("%0.2f ", out[j + X * i]);
        printf("\n");
    }
    printf("\n");

    free(data); free(mask); free(out); free(fmask);

    return EXIT_SUCCESS;
}

static const double LINES[1078] = 
   {1.026243414725960292e+03, 3.589764045416029603e+02, 1.003827043329414323e+03, 3.635882841117418138e+02, 4.015673942462531620e+00, 1.666666666666666574e-01, 2.702184235264919465e+00,
    1.820066017338934898e+03, 6.237075774708293920e+02, 1.847265045594071807e+03, 6.705306799270769034e+02, 7.375333943198858933e+00, 3.333333333333333148e-01, 4.430066997812769358e+00,
    8.266248564220207129e+01, 1.441750924181197661e+03, 7.311417169526129101e+01, 1.428685674010774392e+03, 3.360354758773602679e+00, 1.666666666666666574e-01, 9.586923909257478726e-01,
    7.088619638368508902e+01, 2.150011939477266878e+03, 5.849165974344397512e+01, 2.132965856323164644e+03, 5.637194564554046217e+00, 8.333333333333332871e-02, 4.072131771007022394e+00,
    3.792506813579128107e+02, 6.671752562557758210e+02, 4.022809270320172459e+02, 6.412257111625482366e+02, 6.367748898850188688e+00, 1.666666666666666574e-01, 5.974371890229402737e+00,
    9.859404620043897012e+02, 3.662075984689431607e+02, 1.021487571177336918e+03, 3.675434657955244688e+02, 5.034672434184233047e+00, 3.333333333333333148e-01, 2.921293352509401586e+00,
    5.002646820395739269e+01, 2.126670523224281169e+03, 2.319283956252196433e+01, 2.101291499106950596e+03, 4.974774408722044683e+00, 3.333333333333333148e-01, 8.808304853779397092e+00,
    1.848145025618141744e+03, 6.638283581040893750e+02, 1.806940820595649257e+03, 5.922998214083438597e+02, 9.419135283677036341e+00, 3.333333333333333148e-01, 7.512323362357108181e+00,
    4.042211629821907763e+02, 1.205813751553733482e+03, 4.095883132463375205e+02, 1.231865933462575640e+03, 4.479942808947274813e+00, 3.333333333333333148e-01, 3.613861364943421250e+00,
    4.141188286555549780e+02, 1.231899972647283903e+03, 4.067364439155852551e+02, 1.204017507442938722e+03, 5.781788060276949359e+00, 1.666666666666666574e-01, 1.944643295441498054e+00,
    1.009480987668281500e+03, 3.574226800992653921e+02, 9.811292008178239712e+02, 3.625911758867151207e+02, 6.745611059700785894e+00, 1.666666666666666574e-01, 1.111908985516503634e+00,
    7.416099077460099807e+02, 1.028398364035739405e+03, 7.403418138242633404e+02, 9.839583990941084721e+02, 8.345080781329516029e+00, 3.333333333333333148e-01, 4.952913077163643152e-01,
    1.045086765477604558e+03, 1.886112746020258555e+03, 1.044458498939278570e+03, 1.919455177522939948e+03, 9.096639171467474583e+00, 3.333333333333333148e-01, 3.105833781512977509e+00,
    1.046348269332810901e+02, 9.528546509770953890e+02, 1.029302271526574373e+02, 9.940331840832902799e+02, 7.725166951336227328e+00, 3.333333333333333148e-01, 1.193733299633521483e+00,
    5.166648265631262120e+02, 2.666302106708737938e+02, 5.577218040513158712e+02, 2.531931391481035121e+02, 7.014237922304352502e+00, 3.333333333333333148e-01, 3.828598093073992459e+00,
    1.649369979209370285e+03, 9.490558348879303594e+02, 1.633674297821378559e+03, 8.991624134161601205e+02, 8.205408183815352530e+00, 3.333333333333333148e-01, 4.687321799902480990e+00,
    1.064176725750916432e+02, 9.938001530171159175e+02, 1.098611738147618411e+02, 9.625786452782919014e+02, 6.496540211258353459e+00, 3.333333333333333148e-01, 1.743725247774051468e+00,
    7.096421290718510022e+01, 1.432097332343359540e+03, 8.253648384156085172e+01, 1.457943890375444880e+03, 3.765407935407822482e+00, 3.333333333333333148e-01, 3.162250732860734104e-01,
    8.116487713880729871e+02, 1.942951291249883070e+03, 7.827237689421680216e+02, 1.939968116682459367e+03, 6.438159304488434209e+00, 3.333333333333333148e-01, 2.035585336802832046e-01,
    7.776641983821986059e+02, 1.824100693847740786e+03, 7.637078881852737595e+02, 1.853223507693612873e+03, 5.739985577258387650e+00, 3.333333333333333148e-01, 1.513247686755430976e+00,
    7.735452000944665087e+02, 1.942004619509869826e+03, 7.981847625809767806e+02, 1.947848627637234586e+03, 3.405251266552925760e+00, 1.666666666666666574e-01, 8.057088735758014764e+00,
    2.114000155716493623e+01, 2.104396815811152010e+03, 4.261446861707074163e+01, 2.125204168924668920e+03, 6.983425190403160343e+00, 3.333333333333333148e-01, 7.809452813945828353e+00,
    1.070525836642859076e+03, 2.032431166034293483e+03, 1.138376415186550958e+03, 2.026613574858984748e+03, 5.477110309231670193e+00, 3.333333333333333148e-01, 1.358088777750894138e+01,
    9.083983110999674864e+02, 8.753813026466503970e+02, 9.348644462258670274e+02, 8.708712097662890983e+02, 4.543337435369167565e+00, 3.333333333333333148e-01, 5.895160215225484279e+00,
    1.139751592894465830e+03, 6.610018431781002164e+02, 1.203789708158345093e+03, 6.905874522666175608e+02, 1.297145184385714778e+01, 3.333333333333333148e-01, 1.408197072475136480e+01,
    1.394659613430285845e+03, 9.977890770964869489e+02, 1.411623782490242320e+03, 1.056444864556421408e+03, 8.565097726021008384e+00, 3.333333333333333148e-01, 9.344084327667655288e+00,
    1.628725344596195100e+03, 9.008015056607951010e+02, 1.642146071322980788e+03, 9.400405315730846496e+02, 8.160628152200034791e+00, 1.666666666666666574e-01, 3.067660507099130740e+00,
    7.844594152661817361e+02, 1.363541162130135717e+03, 7.441937919992089974e+02, 1.335027371968502393e+03, 5.514485639126505134e+00, 3.333333333333333148e-01, 5.986672538389310461e+00,
    9.435064816879778391e+02, 1.471319354365211211e+03, 1.021702023168081269e+03, 1.459682017771528990e+03, 6.103368341368544669e+00, 3.333333333333333148e-01, 2.387497164659433579e+01,
    1.045484586307714608e+03, 1.918282018008090063e+03, 1.121683595551766757e+03, 1.897283653877766028e+03, 8.855657205692073930e+00, 3.333333333333333148e-01, 1.444467322238633145e+01,
    7.863310132054314181e+02, 1.739088586265745789e+03, 8.663177115555506589e+02, 1.745911198345136199e+03, 1.085596261468813672e+01, 3.333333333333333148e-01, 1.444488335704214421e+00,
    5.612440194000631664e+02, 2.498872404300940389e+02, 5.968620281971501527e+02, 2.309878411769341255e+02, 7.030718766856823621e+00, 3.333333333333333148e-01, 4.266804929325093809e+00,
    9.207763526716585147e+02, 8.872251035712316707e+02, 8.850814738474405203e+02, 8.942999506515951680e+02, 7.423129961112456598e+00, 1.666666666666666574e-01, 1.033788914668374304e+00,
    7.886234999367992486e+02, 2.715492057313522309e+02, 7.559434330439215728e+02, 2.810924677790275155e+02, 3.957339694669677055e+00, 1.666666666666666574e-01, 1.610924886240457710e+00,
    3.085466147840539861e+02, 1.773642360569588845e+03, 3.667097680996733402e+02, 1.823961617005814787e+03, 8.496968204446652351e+00, 3.333333333333333148e-01, 2.374020421179544016e+01,
    6.899651496398339532e+02, 3.646608742534090197e+02, 7.406040820939582545e+02, 3.529882996361490655e+02, 6.210564441358111587e+00, 1.666666666666666574e-01, 7.622168733409480978e+00,
    1.795130281266815700e+03, 6.831230221413713934e+02, 1.766428700130307561e+03, 6.366006679945138558e+02, 7.263763581206398534e+00, 3.333333333333333148e-01, 3.024632746446417997e+00,
    1.411572720586645573e+03, 1.015825531351872314e+03, 1.399025178754925946e+03, 9.975094425915199281e+02, 4.216135456536217241e+00, 1.666666666666666574e-01, 1.280481079206197137e-01,
    3.988581054358626830e+02, 6.400324444517175380e+02, 3.841770345866563048e+02, 6.564880013372156782e+02, 4.999073785456810803e+00, 1.666666666666666574e-01, 4.297061589419435279e-01,
    9.685431620344079420e+02, 5.583370203214985850e+02, 1.028496088336738694e+03, 5.696965747965922446e+02, 6.871878616567777875e+00, 3.333333333333333148e-01, 2.090323346727963028e+01,
    7.564952067960376780e+01, 1.427476497861362532e+03, 6.507990596085153356e+01, 1.408289315654716802e+03, 3.636515773379947358e+00, 3.333333333333333148e-01, 4.266523326593336662e+00,
    1.073999716310145914e+03, 1.889289151160658776e+03, 1.099361039523552108e+03, 1.891508608123013346e+03, 3.572905079938000661e+00, 1.666666666666666574e-01, 9.292075803439097115e-01,
    1.053429635215506323e+03, 7.356373780386334147e+02, 1.114857122168245496e+03, 7.609029307445371160e+02, 9.795108915382645165e+00, 1.666666666666666574e-01, 2.473941312693017025e+01,
    1.744153351369441907e+03, 1.273041232425820908e+03, 1.748397217709793040e+03, 1.215086041020292441e+03, 7.413602075097447397e+00, 3.333333333333333148e-01, 1.522670786542229493e+01,
    7.635753190315946313e+02, 2.811457879632939694e+02, 7.935366597336364975e+02, 2.753890281815193362e+02, 6.461144634979012480e+00, 1.666666666666666574e-01, 2.648012341462298025e-01,
    1.462886132722763932e+03, 7.722679092397600016e+02, 1.443386223623959040e+03, 7.397458375123713950e+02, 5.909414016586215901e+00, 1.666666666666666574e-01, 5.542215658985352178e+00,
    7.617765549381907704e+02, 1.799633711503749737e+03, 7.838374678589947280e+02, 1.786825166805022491e+03, 3.080808895162344463e+00, 1.666666666666666574e-01, 3.108185487835378069e+00,
    1.044836932687571334e+03, 1.912405119885128897e+03, 1.075845123636407379e+03, 1.898836583001719873e+03, 5.853379501112995875e+00, 3.333333333333333148e-01, 7.277257869742157936e+00,
    1.762721026928659285e+03, 6.398610340989317820e+02, 1.792216223501793820e+03, 6.846379994320833475e+02, 8.306752060165681684e+00, 1.666666666666666574e-01, 3.897969086028474806e+00,
    7.359061516456746403e+02, 9.816720055288661797e+02, 7.373819790897207440e+02, 1.038329171925616947e+03, 5.941085308677270582e+00, 3.333333333333333148e-01, 9.359889967715997017e+00,
    9.908562275120390268e+02, 1.461184920013276496e+03, 9.466687322062862222e+02, 1.465844059698256160e+03, 6.648374901771848755e+00, 1.666666666666666574e-01, 8.371629528190037917e+00,
    1.742807278178104070e+03, 1.213922342074898552e+03, 1.741210885389821442e+03, 1.268352553611774738e+03, 7.709286798373727656e+00, 3.333333333333333148e-01, 4.788379813474374913e+00,
    7.995942670330971396e+02, 1.944539059783056700e+03, 8.259993301336503464e+02, 1.953121680179038776e+03, 3.588680820249342762e+00, 1.666666666666666574e-01, 9.395799711910903795e-01,
    1.583427662896173842e+03, 9.973569370722174199e+02, 1.561558984945119846e+03, 9.224846962042516907e+02, 1.000549986131832192e+01, 3.333333333333333148e-01, 1.622988772724378848e+01,
    1.517413110899843332e+03, 1.286076181860503766e+03, 1.497412777020805152e+03, 1.282744853040263706e+03, 3.249947062729453329e+00, 3.333333333333333148e-01, 1.605607643010671381e+00,
    7.861252770004739432e+02, 9.538421042705201671e+02, 7.438903751171607155e+02, 9.541171270734138261e+02, 3.535845911730783442e+00, 3.333333333333333148e-01, 1.450466694949197688e+01,
    2.012749707203600735e+02, 1.700077322367306124e+03, 1.724436016804796736e+02, 1.656705752557839332e+03, 1.102942055098383278e+01, 1.666666666666666574e-01, 3.711534310537633274e+00,
    7.424157801103098109e+02, 1.337734716087567222e+03, 7.819737767213696316e+02, 1.365676323726645251e+03, 5.870242854707387714e+00, 3.333333333333333148e-01, 7.202235114552518525e+00,
    1.444042422479291645e+03, 4.892622372026062294e+02, 1.474280974413749618e+03, 5.147421983734008109e+02, 9.881341616100263181e+00, 8.333333333333332871e-02, 1.420661965519121850e+01,
    1.580848799881866853e+03, 1.340101863624874568e+03, 1.592574695977554256e+03, 1.290246459883441048e+03, 9.672106757496514717e+00, 3.333333333333333148e-01, 3.763767270602066617e+00,
    5.653471390216227519e+02, 2.436032833572055267e+02, 5.479209724147629004e+02, 2.531349983139189703e+02, 4.798813282649777356e+00, 1.666666666666666574e-01, 4.655223914581263500e-01,
    1.601774923683309169e+02, 1.649250195590583417e+03, 1.975666784059762904e+02, 1.702072104560348407e+03, 9.599004031225225830e+00, 1.666666666666666574e-01, 1.248461939930198383e+01,
    9.104452704471782454e+02, 1.669133949805900102e+03, 8.380658978751126824e+02, 1.659163674122214161e+03, 7.519817810650807566e+00, 3.333333333333333148e-01, 3.024061424342811577e+01,
    1.879614149394762762e+03, 8.683157210849321928e+02, 1.903853137521184863e+03, 9.435423943421614013e+02, 6.921081814260826803e+00, 3.333333333333333148e-01, 8.584403621157498776e+00,
    1.417375576384011538e+03, 1.060022018822419341e+03, 1.403508843138644579e+03, 1.010351461041682342e+03, 1.015334843716546587e+01, 1.666666666666666574e-01, 4.553228231151702943e+00,
    1.478432392539058810e+03, 5.096635971964685723e+02, 1.451915542329769323e+03, 4.866029873875568228e+02, 8.706601660768223283e+00, 1.666666666666666574e-01, 8.568678064758270096e+00,
    5.933640289251243303e+02, 1.278488006115980852e+03, 5.719168159383448256e+02, 1.205709956620675939e+03, 1.709885124555190217e+01, 3.333333333333333148e-01, 1.025584744920462299e+01,
    2.057317796646318129e+03, 6.250992515325326622e+02, 2.069016756717769567e+03, 6.390507584353205175e+02, 4.588923006953774753e+00, 3.333333333333333148e-01, 2.599832923011245356e+00,
    1.439965888082722813e+03, 7.418317989649792707e+02, 1.460416985244913121e+03, 7.771259676616223260e+02, 6.379285858431338774e+00, 3.333333333333333148e-01, 7.726554592061667392e-01,
    8.366308486937753059e+02, 1.663083829202851348e+03, 8.773608920190506524e+02, 1.669702164727673335e+03, 4.814303481409362817e+00, 3.333333333333333148e-01, 6.590810275687871922e+00,
    1.585719030861879446e+03, 1.284055874229996562e+03, 1.573195533756207851e+03, 1.345537748075763602e+03, 1.834737118662325628e+01, 3.333333333333333148e-01, 9.208140089713623411e+00,
    5.210317356816455003e+02, 2.005214476420877418e+03, 4.963921335268547637e+02, 1.999370664493583035e+03, 4.772817202213900600e+00, 3.333333333333333148e-01, 2.213446737143453191e+00,
    1.708332933562278185e+03, 1.994470139011204992e+02, 1.673689853582203341e+03, 1.940570414736849330e+02, 7.368508889749104895e+00, 1.666666666666666574e-01, 1.688580747505099566e+00,
    7.795284708262455524e+02, 1.784033195810600319e+03, 7.592776908229221817e+02, 1.795824728414506808e+03, 3.700498803855032826e+00, 3.333333333333333148e-01, 4.402413652105902742e+00,
    1.906367448118993025e+03, 9.364033776226939381e+02, 1.882487041474395937e+03, 8.665618036981486512e+02, 7.556401394628197821e+00, 3.333333333333333148e-01, 1.508055601172419458e+01,
    1.120531451013035621e+03, 1.891319597118796992e+03, 1.058006014591234816e+03, 1.910605489578738116e+03, 1.193793032022638734e+01, 1.666666666666666574e-01, 5.155645350948098837e+00,
    6.401316527979837474e+02, 1.540546397845444972e+03, 6.830394167155284322e+02, 1.570307849591266404e+03, 7.684715314664906316e+00, 3.333333333333333148e-01, 3.942613676511967924e-01,
    5.888053974774078370e+01, 1.404690320675825433e+03, 7.286246386463908209e+01, 1.429396518233318830e+03, 4.398631938071676295e+00, 1.666666666666666574e-01, 2.468239404011743687e+00,
    4.446849545404825221e+02, 1.406589749972702975e+03, 4.525105716637877435e+02, 1.429907027726758315e+03, 1.018737725890047052e+01, 1.666666666666666574e-01, 5.703196508923777941e+00,
    3.625216111445554361e+02, 1.814150074245963197e+03, 3.243063448146893961e+02, 1.775709150712828205e+03, 1.652915345157306604e+01, 3.333333333333333148e-01, 1.293957212937249679e+01,
    5.962424102377568715e+02, 2.286749456878389424e+02, 5.582659941375172821e+02, 2.432712277055516097e+02, 9.094393460279844632e+00, 1.666666666666666574e-01, 3.540214567424435188e+00,
    1.101678882681964978e+03, 1.886471022780920521e+03, 1.046101886826620330e+03, 1.885567228935673029e+03, 7.234754104841166544e+00, 3.333333333333333148e-01, 5.302933042920919604e+00,
    3.648951894766676105e+02, 9.718000894394480156e+02, 3.760153047650538269e+02, 9.200573839834685259e+02, 1.032468267432429698e+01, 8.333333333333332871e-02, 2.152660024484458390e+01,
    4.130145963781973819e+02, 1.501476355550026938e+03, 4.379039812011100139e+02, 1.532448110553855713e+03, 5.923942172322258060e+00, 3.333333333333333148e-01, 1.761698564978381398e+00,
    6.853381290916751141e+02, 1.568219142263088997e+03, 6.380555326730266188e+02, 1.531557629437966398e+03, 9.780032457666990808e+00, 3.333333333333333148e-01, 3.479934559038355246e+00,
    8.611069456141477758e+02, 8.811006030998897813e+02, 9.083942144713797688e+02, 8.767769626762385542e+02, 1.851329469745401823e+01, 3.333333333333333148e-01, 5.639801210985499580e+00,
    1.693530347533040185e+03, 6.443625293307451329e+02, 1.706112477782986161e+03, 6.538870834874750244e+02, 2.978154204153737439e+00, 8.333333333333332871e-02, 1.624326090644046872e+00,
    9.998545408083217580e+02, 5.559937248118156958e+02, 9.713085987460838169e+02, 5.534275210877412974e+02, 8.226111636209251898e+00, 3.333333333333333148e-01, 1.196399866182854765e+00,
    5.643509253453838710e+02, 1.208470063664675536e+03, 5.900364791707837639e+02, 1.279229536968173761e+03, 1.404231598620761190e+01, 3.333333333333333148e-01, 1.676199042071900180e+00,
    3.655537369153548184e+02, 9.524262143671230660e+02, 3.515082538889215584e+02, 9.832124239537851054e+02, 5.770428644774349358e+00, 1.666666666666666574e-01, 3.138706460068849680e+00,
    7.438975660579244504e+02, 9.566786909950867539e+02, 7.872198581336956522e+02, 9.573703069181199226e+02, 4.479350192657963525e+00, 3.333333333333333148e-01, 1.143131834372983491e+00,
    1.210609466149407808e+03, 6.883159504122423868e+02, 1.129870761325018293e+03, 6.463164292770584325e+02, 2.161561718095392237e+01, 3.333333333333333148e-01, 1.790462400560228318e+01,
    1.145860401938391675e+02, 1.377305771263808992e+03, 1.000581697434029422e+02, 1.305324641122963385e+03, 1.280017236658347990e+01, 3.333333333333333148e-01, 5.266158388243646016e+00,
    7.853229238056804888e+02, 1.725928421894261646e+03, 7.871869238293290891e+02, 1.740560052402653582e+03, 3.435314179469806106e+00, 1.666666666666666574e-01, 5.084974313541650304e+00,
    4.837648447463583352e+02, 1.998664933920646945e+03, 5.216452200451531098e+02, 2.012835109886692180e+03, 8.182877046972807378e+00, 1.666666666666666574e-01, 5.425865141267014025e+00,
    8.782084052711489903e+02, 1.670752613939055436e+03, 9.059695331203224669e+02, 1.672186157405673384e+03, 4.991129281910949622e+00, 1.666666666666666574e-01, 3.189334059578730063e+00,
    1.029202154677809403e+03, 5.635752490004260835e+02, 1.000232315655897423e+03, 5.612508092305554328e+02, 7.533971243618807989e+00, 3.333333333333333148e-01, 2.183687900772461887e-01,
    4.524802587553272701e+02, 1.539701220288817012e+03, 4.302780964328229629e+02, 1.513976192895337363e+03, 3.331187161986413070e+00, 1.666666666666666574e-01, 1.828046908524772363e+00,
    1.261917677976863160e+03, 1.491152453453284352e+03, 1.249013088723752844e+03, 1.512737341508716327e+03, 4.851598764567629729e+00, 3.333333333333333148e-01, 1.839213350349009346e+00,
    5.225191801682912001e+02, 1.364630528377841529e+03, 5.045988991268918085e+02, 1.327415365009232346e+03, 8.305919804454415356e+00, 1.666666666666666574e-01, 8.509002155442932036e+00,
    1.245963994019072061e+03, 6.152592917303514923e+02, 1.285284078505459320e+03, 6.375687440238096997e+02, 8.067092153125674514e+00, 1.666666666666666574e-01, 7.176661686874389545e+00,
    1.108764775822173533e+03, 2.510358745760406123e+02, 1.188289408725003113e+03, 2.707328964940685410e+02, 1.027092361169690093e+01, 3.333333333333333148e-01, 1.509976175221304473e+01,
    2.716479669846322054e+02, 1.062623213421102037e+03, 2.782950136526812344e+02, 1.014035652681819556e+03, 7.976221136057874084e+00, 3.333333333333333148e-01, 8.904117760749482358e+00,
    1.190583205000677708e+03, 2.648892365067925425e+02, 1.110576173849708312e+03, 2.449174032507974914e+02, 1.428350644401480452e+01, 3.333333333333333148e-01, 5.481920806176276528e+00,
    1.115939146270323818e+03, 7.565132140219915300e+02, 1.058658893173418846e+03, 7.320165258918408426e+02, 9.174996258978509900e+00, 3.333333333333333148e-01, 1.429733825813947590e+01,
    5.450364418744501336e+02, 2.472896614502233206e+02, 5.261646643055361210e+02, 2.574873308068004008e+02, 3.612492401881708837e+00, 1.666666666666666574e-01, 2.482265900511048784e+00,
    8.072609928549940150e+02, 6.676899968695796588e+02, 8.498353919969429171e+02, 6.641612968771001988e+02, 8.038496574416784668e+00, 4.166666666666666435e-02, 1.345231469080614062e+01,
    1.672566845732075308e+03, 1.970584809919472207e+02, 1.708800097614156357e+03, 2.051258199442772252e+02, 8.566135770254810211e+00, 1.666666666666666574e-01, 2.511165086117120637e+00,
    1.171823078113586007e+03, 1.746466024228084734e+03, 1.229225026529766637e+03, 1.721168785612868760e+03, 8.323068035662656072e+00, 3.333333333333333148e-01, 1.437444531758575650e+01,
    2.030648453878575310e+03, 5.809979069113045398e+02, 2.058312577610270182e+03, 6.169812933601582472e+02, 9.282318698523065237e+00, 3.333333333333333148e-01, 1.462278740611087002e+01,
    5.045344539084903772e+02, 1.337447424309635380e+03, 5.235569963109887794e+02, 1.375167376686299576e+03, 7.664489962667842882e+00, 8.333333333333332871e-02, 4.144012200875412333e+00,
    1.075061412609831450e+03, 1.894743338752892441e+03, 1.045676354795789166e+03, 1.903335399397070205e+03, 9.938613900041278981e+00, 1.666666666666666574e-01, 5.437025016865472793e+00,
    8.593921675824493605e+02, 1.739384382664945861e+03, 7.994851042840938362e+02, 1.736404738240666802e+03, 8.607754401907145692e+00, 3.333333333333333148e-01, 1.146186826840935424e+00,
    2.067837988688560472e+03, 6.224254762116617030e+02, 2.033207181206181758e+03, 5.618963954444342335e+02, 1.172649654552327547e+01, 3.333333333333333148e-01, 1.629007615208497128e+00,
    1.555032653301389018e+03, 9.347705117218049509e+02, 1.570607557725605147e+03, 9.689138764011734111e+02, 1.470239207973643936e+01, 3.333333333333333148e-01, 4.390965355160499684e+00,
    1.570799394018190242e+03, 9.693732684390594159e+02, 1.579865565676326469e+03, 1.000432631031080177e+03, 8.002465273020927583e+00, 1.666666666666666574e-01, 4.552719677722350866e+00,
    1.710368495646339852e+03, 6.466772749921747163e+02, 1.694018239370840547e+03, 6.412751687172305992e+02, 3.392154915310814811e+00, 1.666666666666666574e-01, 2.514397403549285315e+00,
    8.588608461058423700e+02, 8.561583877800931077e+02, 8.623845662870554634e+02, 8.996563178952621911e+02, 5.782048399840505226e+00, 1.666666666666666574e-01, 4.485350538249122110e+00,
    1.495468872704209389e+03, 1.321008781458699104e+03, 1.485369220266768934e+03, 1.356217023707963563e+03, 4.587048646022691578e+00, 3.333333333333333148e-01, 1.693141852285627635e+00,
    1.494898200920910540e+03, 1.338565984845541379e+03, 1.498040773293876100e+03, 1.324932563435853353e+03, 4.995164728561264589e+00, 1.666666666666666574e-01, 3.059133535074469279e+00,
    1.801673241175135445e+03, 5.944005192430450961e+02, 1.819495687928864527e+03, 6.276290961594397686e+02, 8.785670415176124237e+00, 3.333333333333333148e-01, 3.855154585278906865e+00,
    4.828679876250459984e+02, 1.462011855331530796e+03, 4.473645690375542472e+02, 1.406326059658263830e+03, 1.395917034259231571e+01, 1.666666666666666574e-01, 1.939723573695048842e+01,
    1.481377713382055163e+03, 1.334843519734035908e+03, 1.476007682489503395e+03, 1.382890402900198296e+03, 1.080854918739498061e+01, 1.666666666666666574e-01, 4.447444163478323276e+00,
    7.661864033369242861e+02, 9.902377849155163858e+02, 7.389430557977134413e+02, 9.837827761249697005e+02, 6.061431909901214610e+00, 3.333333333333333148e-01, 2.361543152287552516e+00,
    5.458593589623538946e+02, 2.021023453871044012e+03, 5.204121463377242662e+02, 2.007331610481006919e+03, 6.094196268073564404e+00, 3.333333333333333148e-01, 5.867616312718162419e-01,
    1.485793925885684530e+03, 1.362365879156811616e+03, 1.491460018090723224e+03, 1.342718183517624539e+03, 1.330299783235770761e+01, 8.333333333333332871e-02, 9.250058570252690515e-01,
    9.166620220937593899e+01, 1.308333466353393533e+03, 1.119203613181429802e+02, 1.379053565565938925e+03, 1.084230497718722397e+01, 3.333333333333333148e-01, 1.223007660420912046e+01,
    9.094292288894838521e+02, 8.705037911004575335e+02, 8.912615452275920234e+02, 8.758439688100735339e+02, 7.649449083676634231e+00, 3.333333333333333148e-01, 6.365376362273696742e+00,
    1.138317606877435992e+03, 2.021436527497308816e+03, 1.102851735844791847e+03, 2.023860071730159689e+03, 5.315377814666320866e+00, 3.333333333333333148e-01, 6.754915855364753696e+00,
    4.532352589208115319e+02, 1.428274456531520173e+03, 4.704133994862248755e+02, 1.448454343768747549e+03, 6.563965285755672063e+00, 1.666666666666666574e-01, 6.468176090021966473e+00,
    4.687633130317664722e+02, 1.449491549543412248e+03, 4.862897864108317094e+02, 1.474876638292859070e+03, 5.887180116255217754e+00, 1.666666666666666574e-01, 9.519045518078748103e-01,
    7.260601700036693273e+02, 3.544142745044580920e+02, 6.994018764749567936e+02, 3.567327718299076196e+02, 5.885141104811532742e+00, 1.666666666666666574e-01, 2.638764353729953882e+00,
    8.484597269979680050e+02, 6.607846437109800490e+02, 8.029106869042527705e+02, 6.631332284314364642e+02, 7.001110734177874662e+00, 3.333333333333333148e-01, 9.632873945026787510e+00,
    7.769933690327276281e+02, 1.932943172592733845e+03, 7.481564118195638002e+02, 1.930179149078581986e+03, 4.176516708467583605e+00, 3.333333333333333148e-01, 1.839213350349009346e+00,
    8.736817405194068442e+02, 1.992612034543177799e+02, 8.862922609542642931e+02, 1.972430132386086257e+02, 4.520564169241077401e+00, 1.666666666666666574e-01, 1.180295165555467207e+00,
    1.022355346407604316e+03, 1.453912759268538366e+03, 9.906496997876175783e+02, 1.457959778356334709e+03, 6.983170505007125328e+00, 3.333333333333333148e-01, 7.230871751820181714e+00,
    5.026439315971999804e+02, 1.997421626619903236e+03, 4.842181494427910025e+02, 1.985053691939405326e+03, 2.757538819351696535e+00, 1.666666666666666574e-01, 1.971686766221051101e+00,
    3.610411382943385092e+02, 9.241678766536372223e+02, 3.654751776191230306e+02, 9.517688281487418180e+02, 7.623051939485253392e+00, 3.333333333333333148e-01, 2.987024732567938656e+00,
    1.570929589313408314e+03, 1.345033879836224514e+03, 1.570626736997960961e+03, 1.358309609959542058e+03, 3.357517925694235572e+00, 8.333333333333332871e-02, 3.098911351163614825e+00,
    7.437934592191061256e+02, 9.887401649678984086e+02, 7.658448890689311384e+02, 9.939127240562667112e+02, 2.291745212413399013e+00, 3.333333333333333148e-01, 6.715912442641638336e-01,
    1.745269180088588428e+03, 1.178517597196792394e+03, 1.743973580160093661e+03, 1.196035197203344524e+03, 4.735979434493462925e+00, 3.333333333333333148e-01, 7.418307356503603955e-01,
    9.309110085621487087e+02, 8.681064835473240464e+02, 8.968057808510480982e+02, 8.641045232115056933e+02, 1.654736478018883616e+01, 3.333333333333333148e-01, 3.113944899567436764e+01,
    2.701305219290632635e+02, 1.012407211153119988e+03, 2.663675297272748708e+02, 1.061855290900278305e+03, 1.087807412177989796e+01, 3.333333333333333148e-01, 8.503739242615186100e+00,
    7.482707671268098011e+02, 1.934696630002081974e+03, 7.761395326037680888e+02, 1.936855295579342737e+03, 3.619263191547589464e+00, 3.333333333333333148e-01, 2.484779650627707781e+00,
    1.572471604615890328e+03, 1.359339084568269982e+03, 1.579224555096343693e+03, 1.339715179570060400e+03, 7.320512076145998748e+00, 1.666666666666666574e-01, 2.624163385476798283e+00,
    1.471917141423726889e+03, 1.395100734999072074e+03, 1.485158220710339492e+03, 1.362177161781451105e+03, 6.207626394615280319e+00, 1.666666666666666574e-01, 4.815553060714403699e+00,
    1.231521101478753053e+03, 1.714667203885940808e+03, 1.166915197695870575e+03, 1.740355598316405349e+03, 1.574793654700787293e+01, 3.333333333333333148e-01, 8.384812389079847605e+00,
    3.543775360985466705e+02, 9.853825288707379286e+02, 3.616473438836856644e+02, 9.760959846104226472e+02, 5.257517212880133961e+00, 3.333333333333333148e-01, 2.754864567125423491e-01,
    1.281219747627509832e+03, 6.340811695129127656e+02, 1.274301404883710802e+03, 6.180008228460862938e+02, 3.604372033941440012e+00, 3.333333333333333148e-01, 4.413658833953110872e+00,
    8.907072204953714163e+02, 8.601860238419653797e+02, 8.661170526409340482e+02, 8.761202802378044225e+02, 1.538644326794399753e+01, 3.333333333333333148e-01, 2.860980878160752638e-01,
    4.875143356661714620e+02, 1.475131093707904711e+03, 4.831859974804470426e+02, 1.448090140076627222e+03, 1.976775791258245762e+00, 3.333333333333333148e-01, 4.249189109227557992e-01,
    1.591665500245151634e+03, 1.291455038772882517e+03, 1.579639847011651682e+03, 1.278156632199909609e+03, 4.652828506054207836e+00, 1.666666666666666574e-01, 1.847667908626888789e+00,
    8.738049721349166248e+02, 8.583242645374936046e+02, 8.604643842437383228e+02, 8.573084243865353073e+02, 3.492437488392586165e+00, 1.666666666666666574e-01, 1.192103028913358287e-01,
    8.606708001934595131e+02, 8.601683372188284693e+02, 8.833206055050048917e+02, 8.669094141879332938e+02, 3.772155417990622261e+00, 3.333333333333333148e-01, 3.245871328483335816e+00};

static int test_pairs()
{
    double x_c = 930;
    double y_c = 1144;

    int X = 2068;
    int Y = 2160;
    int n_lines = 154;
    double *data = (double *)malloc(X * Y * sizeof(double));
    double *ilines = (double *)LINES;
    double *olines = (double *)malloc(n_lines * 7 * sizeof(double));
    for (int i = 0; i < X * Y; i++) data[i] = 1.0;

    filter_lines(olines, data, Y, X, ilines, n_lines, x_c, y_c, 1.);

    // printf("%3d pairs found.\n", n_pairs);

    return 0;
}